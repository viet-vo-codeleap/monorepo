name: Merge PR into main

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - '.gitignore'
      - 'infrastructure/**'

env:
  DOTNET_IMAGE: sample-dotnet-8
  CONTAINER_APP_NAME: ca-viet-vo-neovaude-dev
  RESOURCE_GROUP: rg-viet-vo-neovaude-dev

jobs:
  determine-changes:
    uses: ./.github/workflows/rw-determine-changes.yml
  
  # Frontend Pipeline
  build-artifact-frontend:
    needs: determine-changes
    if: needs.determine-changes.outputs.frontend-changed == 'true'
    uses: ./.github/workflows/rw-build-artifact-frontend.yml

  deploy-frontend:
    runs-on: ubuntu-latest
    needs: build-artifact-frontend
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: ./dist
      - uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.SWA_DEPLOYMENT_TOKEN }}
          action: upload
          app_location: ./dist
          skip_app_build: true
  
  # Backend Pipeline
  build-docker-backend:
    needs: determine-changes
    if: needs.determine-changes.outputs.backend-changed == 'true'
    uses: ./.github/workflows/rw-build-docker-backend.yml
    with:
      push: true
    secrets: inherit

  deploy-backend:
    runs-on: ubuntu-latest
    needs: build-docker-backend
    steps:
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - run: |
          az containerapp update \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.DOTNET_IMAGE }}:${{ needs.build-docker-backend.outputs.image_tag }}