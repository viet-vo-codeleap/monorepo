name: Merge PR into main

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - '.gitignore'
      - 'infrastructure/**'

env:
  DOTNET_IMAGE: sample-dotnet-8
  CONTAINER_APP_NAME: ca-viet-vo-neovaude-dev
  RESOURCE_GROUP: rg-viet-vo-neovaude-dev

jobs:
  determine-changes:
    uses: ./.github/workflows/rw-determine-changes.yml
  
  # Frontend Pipeline
  build-artifact-frontend:
    runs-on: ubuntu-latest
    needs: determine-changes
    if: needs.determine-changes.outputs.frontend-changed == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      - run: |
          cd frontend
          npm ci
          npm run build
      - uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist/deploy-angular-app/browser
  deploy-frontend:
    runs-on: ubuntu-latest
    needs: build-artifact-frontend
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: ./dist
      - uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.SWA_DEPLOYMENT_TOKEN }}
          action: upload
          app_location: ./dist
          skip_app_build: true
  
  # Backend Pipeline
  build-docker-backend:
    runs-on: ubuntu-latest
    needs: determine-changes
    if: needs.determine-changes.outputs.backend-changed == 'true'
    outputs:
      image_tag: ${{ steps.meta.outputs.sha }}
    steps:
      - uses: actions/checkout@v4
      - id: meta
        run: echo "sha=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - run: az acr login --name ${{ secrets.ACR_NAME }}
      - uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.DOTNET_IMAGE }}:${{ steps.meta.outputs.sha }}
            ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.DOTNET_IMAGE }}:latest

  deploy-backend:
    runs-on: ubuntu-latest
    needs: build-docker-backend
    steps:
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - run: |
          az containerapp update \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.DOTNET_IMAGE }}:${{ needs.build-docker-backend.outputs.image_tag }}